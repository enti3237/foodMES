Imports Excel = Microsoft.Office.Interop.Excel
Imports System.Runtime.InteropServices

Public Class Frm_LA_Order
    Dim xlapp As Excel.Application
    Dim xlbook As Excel.Workbook
    Dim xlsheet As Excel.Worksheet
    'hsim 20200508 사용 테이블 저장용 변수 선언
    '#1. 사용자 테이블
    Dim tblLaOrder As New DataTable
    Dim tblLaOrderList As New DataTable

    Dim prcType As New String(String.Empty)
    Dim histLogStr As New String(String.Empty)
    Dim fmtStr As New String(String.Format("yyyy-MM-dd")), fmtStr2 As New String(String.Format("yyyy-MM-dd HH:mm:ss"))

    Private Sub Frm_LA_Order_Load(sender As Object, e As EventArgs) Handles MyBase.Load
        Me.Dock = DockStyle.Fill
        Me.BringToFront()

        palMain.Top = 40
        palMain.Left = 10
        palDetail.Top = 40
        palDetail.Left = 10

        palMain.Visible = True
        palDetail.Visible = False

        '#1. 사용자 테이블
        tblLaOrder = fnGetTableStructure("LA_Order")
        tblLaOrderList = fnGetTableStructure("LA_Order_List")

        comboSetUp1(cboItmUnit3, "1050")

        LA_Load()
        'Setup()
    End Sub



    Private Sub btnMain_Click(sender As Object, e As EventArgs) Handles btnMain.Click
        Label_Color(sender, Color_Label, Di_Panel2)
        palMain.Visible = True
        palDetail.Visible = False
    End Sub

    Private Sub btnDetail_Click(sender As Object, e As EventArgs) Handles btnDetail.Click
        'Label_Color(sender, Color_Label, Di_Panel2)
        'palMain.Visible = False
        'palDetail.Visible = True
    End Sub

    Private Sub LA_Load()
        Dim DBT As DataTable, DBT2 As DataTable
        DBT = Nothing
        DBT2 = Nothing

        StrSQL = " select LO.LO_Job_No LO_Job_No, CR.CR_Name LO_Job_Name, LO_Code, LO_Rev_No, LO_Name, LO_Issue_Date, LO_Bigo " &
                 " , LO_Prepared, LO_Reviewed, LO_Approved " &
                 " ,(select Man_Name from Man where Man_Code = LO.LO_Prepared) LO_Prepared_Name " &
                 " ,(select Man_Name from Man where Man_Code = LO.LO_Reviewed) LO_Reviewed_Name " &
                 " ,(select Man_Name from Man where Man_Code = LO.LO_Approved) LO_Approved_Name " &
                 "   From CR_Contract CR , LA_Order LO " &
                 "   Where 1=1 " &
                 "   AND LO.LO_Rev_No = (select isnull(max(LO_Rev_No),1) from LA_Order where LO_Code = LO.LO_code) " &
                 "   AND LO.LO_Job_No Like '%" & txtJobNo.Text & "%' " &
                 "   AND CR.CR_Name Like '%" & txtJobName.Text & "%' " &
                 "   AND LO.LO_Code Like '%" & txtPRNo.Text & "%' " &
                 "   AND LO.LO_Job_No = CR.CR_Code " &
                 "   And CR.CR_Rev_No = ( select isnull(max(CR_Rev_No),1) from CR_Contract where CR_Code = CR.CR_Code) " &
                 "   order by LO.LO_Job_No, LO.LO_Code "
        Console.WriteLine(StrSQL)
        Re_Count = DB_Select(DBT)

        lstMain.DataSource = DBT

        If Re_Count > 0 Then

            lstMain.ClearSelection()
        End If

        'hsim 20200517 이력 내역 조회
        showRevLog("Frm_LA_Order", DBT2, lstRev)

    End Sub

    Private Sub Text_Clear()
        txtItmDesc3.Text = ""
        txtDWGCode3.Text = ""
        txtItmPartNo3.Text = ""
        txtItmPartName3.Text = ""
        txtSpec3.Text = ""
        txtSize3.Text = ""
        cboItmUnit3.Text = ""
        txtQty3.Text = ""
        txtPSNo3.Text = ""
        txtBigo3.Text = ""
        dtpDelivery3.Text = ""
    End Sub

    Private Sub lstMain_CellDoubleClick(sender As Object, e As DataGridViewCellEventArgs) Handles lstMain.CellDoubleClick
        Label_Color(btnDetail, Color_Label, Di_Panel2)
        palMain.Visible = False
        palDetail.Visible = True

        Dim DBT As DataTable
        DBT = Nothing

        StrSQL = " SELECT a.LO_List_Code LO_List_Code, a.LO_Code LO_Code, a.LO_Rev_No LO_Rev_No, a.LO_Sun LO_Sun  " &
                 "        ,a.LO_Itm_Desc LO_Itm_Desc, a.LO_DV_Code LO_DV_Code, a.LO_Itm_Part_No LO_Itm_Part_No, a.LO_Itm_Part_Name LO_Itm_Part_Name " &
                 "        ,a.LO_Itm_Spec LO_Itm_Spec, a.LO_Itm_Size LO_Itm_Size, a.LO_Itm_Unit LO_Itm_Unit, a.LO_Itm_Qty LO_Itm_Qty " &
                 "        ,a.LO_BO_List_Code LO_BO_List_Code, a.LO_CR_List_Code LO_CR_List_Code, a.LO_PS_Code LO_PS_Code, a.LO_Itm_Delivery_Date LO_Itm_Delivery_Date " &
                 "        ,a.LO_Itm_Bigo LO_Itm_Bigo, a.LO_Prepared LO_Prepared, a.LO_Prepare_Date LO_Prepare_Date, a.LO_Updated LO_Updated, a.LO_Update_Date LO_Update_Date " &
                 ", (select Base_Name from Base_Code where Base_Sel_Code = '1050' and Base_Code = a.LO_Itm_Unit ) LO_Itm_Unit_Name " & '수량 단위"
                 ", (select CR_PL_Code from CR_Contract_List where CR_List_Code = a.LO_CR_List_Code) As LO_CR_PL_Code " &
                 ", (select CR_PL_Name from CR_Contract_List where CR_List_Code = a.LO_CR_List_Code) As LO_CR_PL_Name " &
                 ", (select BO_Itm_Name from BO_BOM_List where BO_List_Code = a.LO_BO_List_Code) As LO_BO_List_Name " &
                 ", (select CR_PL_Name from CR_Contract_List where CR_List_Code = a.LO_CR_List_Code) As LO_CR_List_Name " &
                 ", (select BO_Code from BO_BOM_List where BO_List_Code = a.LO_BO_List_Code) As BO_Code " &
                 ", (select BO_Rev_No from BO_BOM_List where BO_List_Code = a.LO_BO_List_Code) As BO_Rev_No " &
                 ", (select BO_Sun from BO_BOM_List where BO_List_Code = a.LO_BO_List_Code) As BO_Sun " &
                 " FROM LA_Order_List a " &
                 " Where a.LO_Code = '" & lstMain.Rows(e.RowIndex).Cells("LO_Code2").Value.ToString() & "'" &
                 " And a.LO_Rev_No = '" & lstMain.Rows(e.RowIndex).Cells("LO_Rev_No2").Value.ToString() & "'" &
                 " order By a.LO_Sun ASC "
        Re_Count = DB_Select(DBT)

        If Re_Count > 0 Then
            lstDetail.DataSource = DBT
            lstDetail.ClearSelection()

            txtLOListCode3.Text = DBT.Rows(0)("LO_List_Code").ToString
            txtLOCode3.Text = DBT.Rows(0)("LO_Code").ToString
            txtLORevNo3.Text = DBT.Rows(0)("LO_Rev_No").ToString
            txtSun3.Text = DBT.Rows(0)("LO_Sun").ToString
            txtItmDesc3.Text = DBT.Rows(0)("LO_Itm_Desc").ToString
            txtDWGCode3.Text = DBT.Rows(0)("LO_DV_Code").ToString
            txtItmPartNo3.Text = DBT.Rows(0)("LO_Itm_Part_No").ToString
            txtItmPartName3.Text = DBT.Rows(0)("LO_Itm_Part_Name").ToString
            txtSpec3.Text = DBT.Rows(0)("LO_Itm_Spec").ToString
            txtSize3.Text = DBT.Rows(0)("LO_Itm_Size").ToString
            txtQty3.Text = DBT.Rows(0)("LO_Itm_Qty").ToString
            cboItmUnit3.SelectedValue = DBT.Rows(0)("LO_Itm_Unit").ToString
            txtBOMCode3.Text = DBT.Rows(0)("BO_Code").ToString
            txtBOMRev3.Text = DBT.Rows(0)("BO_Rev_No").ToString
            txtBOMSun3.Text = DBT.Rows(0)("BO_Sun").ToString
            lblCRListCode3.Text = DBT.Rows(0)("LO_CR_List_Code").ToString
            lblBOListCode3.Text = DBT.Rows(0)("LO_BO_List_Code").ToString
            txtPLName3.Text = DBT.Rows(0)("LO_CR_PL_Name").ToString
            cboPLName3.SelectedValue = DBT.Rows(0)("LO_CR_PL_Code").ToString
            txtPSNo3.Text = DBT.Rows(0)("LO_PS_Code").ToString
            dtpDelivery3.Value = DBT.Rows(0)("LO_Itm_Delivery_Date").ToString
            txtBigo3.Text = DBT.Rows(0)("LO_Itm_Bigo").ToString
        End If

        btnDetail.PerformClick()

    End Sub

    Private Sub Com_Can_Click(sender As Object, e As EventArgs)
        Text_Clear()
        Label_Color(btnMain, Color_Label, Di_Panel2)
        palMain.Visible = True
        palDetail.Visible = False
    End Sub

    Private Sub Button10_Click(sender As Object, e As EventArgs)
        Text_Clear()
        Label_Color(btnDetail, Color_Label, Di_Panel2)
        palMain.Visible = False
        palDetail.Visible = True
    End Sub

    Private Sub lstDetail_CellClick(sender As Object, e As DataGridViewCellEventArgs) Handles lstDetail.CellClick
        If e.RowIndex >= 0 Then
            txtLOCode3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_Code3").Value.ToString
            txtLORevNo3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_Rev_No3").Value.ToString
            txtSun3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_Sun3").Value.ToString
            txtLOListCode3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_List_Code").Value.ToString
            txtItmDesc3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_Itm_Desc").Value.ToString
            txtDWGCode3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_DV_Code").Value.ToString
            txtBOMCode3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("BO_Code").Value.ToString
            txtBOMRev3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("BO_Rev_No").Value.ToString
            txtBOMSun3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("BO_Sun").Value.ToString
            txtItmPartNo3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_Itm_Part_No").Value.ToString
            txtItmPartName3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_Itm_Part_Name").Value.ToString
            txtSpec3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_Itm_Spec").Value.ToString
            txtSize3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_Itm_Size").Value.ToString
            cboItmUnit3.SelectedValue = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_Itm_Unit").Value.ToString
            txtQty3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_Itm_Qty").Value.ToString
            txtPSNo3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_PS_Code3").Value.ToString
            txtPLName3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_CR_PL_Name").Value.ToString
            dtpDelivery3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_Itm_Delivery_Date").Value.ToString
            txtBigo3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_Itm_Bigo3").Value.ToString
            lblBOListCode3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_BO_List_Name").Value.ToString
            lblCRListCode3.Text = lstDetail.Rows(lstDetail.CurrentRow.Index).Cells("LO_CR_List_Name").Value.ToString
        End If

    End Sub

    Private Sub Button11_Click(sender As Object, e As EventArgs) Handles btnJobSearch.Click
        Dim pop1 As Frm_Contract_POP = New Frm_Contract_POP
        pop1.StartPosition = FormStartPosition.CenterScreen
        If (pop1.ShowDialog(Me) = DialogResult.OK) Then
            txtJobNo.Text = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("CR_Code").Value.ToString
            txtJobName.Text = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("CR_Name").Value.ToString
        End If
        pop1.Dispose()
    End Sub

    Private Sub lstMain_CellClick(sender As Object, e As DataGridViewCellEventArgs) Handles lstMain.CellClick

        Dim cboDBT As New DataTable(), cboDBT2 As New DataTable(), cboDBT3 As New DataTable()
        If e.RowIndex >= 0 Then
            txtLOCode2.Text = lstMain.Rows(e.RowIndex).Cells("LO_Code2").Value.ToString
            txtRev2.Text = lstMain.Rows(e.RowIndex).Cells("LO_Rev_No2").Value.ToString
            txtLOJobNo2.Text = lstMain.Rows(e.RowIndex).Cells("LO_Job_No").Value.ToString
            txtJobName2.Text = lstMain.Rows(e.RowIndex).Cells("LO_Job_Name").Value.ToString
            txtLOName2.Text = lstMain.Rows(e.RowIndex).Cells("LO_Name").Value.ToString
            dtpRegDate2.Value = lstMain.Rows(e.RowIndex).Cells("LO_Issue_Date").Value.ToString
            txtBigo2.Text = lstMain.Rows(e.RowIndex).Cells("LO_Bigo").Value.ToString
            '#1. 작성자
            cboDBT.Columns.Add("Man_Code")
            cboDBT.Columns.Add("Man_Name")
            cboDBT.Rows.Add()
            cboDBT.Rows(0).Item(0) = lstMain.Rows(e.RowIndex).Cells("LO_Prepared").Value.ToString
            cboDBT.Rows(0).Item(1) = lstMain.Rows(e.RowIndex).Cells("LO_Prepared_Name").Value.ToString
            txtPrepared2.Text = lstMain.Rows(e.RowIndex).Cells("LO_Prepared_Name").Value.ToString
            cboPrepared.DataSource = cboDBT
            cboPrepared.ValueMember = "Man_Code"
            cboPrepared.DisplayMember = "Man_Name"
            '#2. 검토자
            cboDBT2.Columns.Add("Man_Code")
            cboDBT2.Columns.Add("Man_Name")
            cboDBT2.Rows.Add()
            cboDBT2.Rows(0).Item(0) = lstMain.Rows(e.RowIndex).Cells("LO_Reviewed").Value.ToString
            cboDBT2.Rows(0).Item(1) = lstMain.Rows(e.RowIndex).Cells("LO_Reviewed_Name").Value.ToString
            txtReviewed2.Text = lstMain.Rows(e.RowIndex).Cells("LO_Reviewed_Name").Value.ToString
            cboReviewed.DataSource = cboDBT2
            cboReviewed.ValueMember = "Man_Code"
            cboReviewed.DisplayMember = "Man_Name"
            '#3. 승인자
            cboDBT3.Columns.Add("Man_Code")
            cboDBT3.Columns.Add("Man_Name")
            cboDBT3.Rows.Add()
            cboDBT3.Rows(0).Item(0) = lstMain.Rows(e.RowIndex).Cells("LO_Approved").Value.ToString
            cboDBT3.Rows(0).Item(1) = lstMain.Rows(e.RowIndex).Cells("LO_Approved_Name").Value.ToString
            txtApprov2.Text = lstMain.Rows(e.RowIndex).Cells("LO_Approved_Name").Value.ToString
            cboApproved.DataSource = cboDBT3
            cboApproved.ValueMember = "Man_Code"
            cboApproved.DisplayMember = "Man_Name"
        End If

    End Sub

    Private Sub btnAdd_Click(sender As Object, e As EventArgs) Handles btnAdd.Click
        txtLOJobNo2.Text = ""
        txtJobName2.Text = ""
        txtLOName2.Text = ""
        txtLOCode2.Text = ""
        dtpRegDate2.Value = DateTime.Now.ToString(fmtStr2)
        dtpPrepared2.Value = DateTime.Now.ToString(fmtStr2)
        dtpReviewed2.Value = DateTime.Now.ToString(fmtStr2)
        dtpApprov2.Value = DateTime.Now.ToString(fmtStr2)
        txtPrepared2.Text = ""
        txtReviewed2.Text = ""
        txtApprov2.Text = ""
        txtRev2.Text = "1"
        txtBigo2.Text = ""
    End Sub

    Private Sub btnJobSearch2_Click(sender As Object, e As EventArgs) Handles btnJobSearch2.Click
        Dim pop1 As Frm_Contract_POP = New Frm_Contract_POP
        pop1.StartPosition = FormStartPosition.CenterScreen
        If (pop1.ShowDialog(Me) = DialogResult.OK) Then
            txtLOJobNo2.Text = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("CR_Code").Value.ToString
            txtJobName2.Text = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("CR_Name").Value.ToString
        End If
        pop1.Dispose()
    End Sub

    Private Sub btnDelete_Click(sender As Object, e As EventArgs) Handles btnDelete.Click
        Dim DBT As DataTable
        DBT = Nothing
        If MessageBox.Show(txtLOCode2.Text + " 를 삭제하시겠습니까?" & vbCrLf & "상세 내용도 함께 삭제합니다", "삭제", MessageBoxButtons.YesNo) = DialogResult.Yes Then
            If txtLOCode2.Text <> "" Then
                StrSQL = "Delete LA_Order where LO_Code = '" & txtLOCode2.Text & "' and LO_Rev_No = " & txtRev2.Text & " "
                Re_Count = DB_Execute()
                StrSQL = "Delete LA_Order_List where LO_Code = '" & txtLOCode2.Text & "' and LO_Rev_No = " & txtRev2.Text & " "
                DB_Execute()
                If Re_Count > 0 Then
                    MsgBox("삭제 완료")
                End If
                'hsim 20200515 처리 이력
                histLogStr = "사용자 " & logInUserName & " PR 정보 삭제 : " & txtLOCode2.Text & "-" & txtRev2.Text
                Man_Log("Frm_LA_Order", "PR 정보 삭제", loginID, histLogStr, DateTime.Now.ToString(fmtStr2))
            Else
                MsgBox("선택된 PR No. 가 없습니다")
            End If
            LA_Load()
        End If
    End Sub

    Private Sub btnAdd2_Click(sender As Object, e As EventArgs) Handles btnAdd2.Click
        txtLOCode3.Text = ""
        txtLORevNo3.Text = ""
        txtSun3.Text = ""
        txtBOMCode3.Text = -""
        txtBOMRev3.Text = ""
        txtBOMSun3.Text = ""
        txtItmDesc3.Text = ""
        txtDWGCode3.Text = ""
        txtItmPartNo3.Text = ""
        txtItmPartName3.Text = ""
        txtSpec3.Text = ""
        txtSize3.Text = ""
        cboItmUnit3.SelectedValue = ""
        txtQty3.Text = ""
        txtPSNo3.Text = ""
        txtSun3.Text = ""
        dtpDelivery3.Value = DateTime.Now.ToString(fmtStr2)
        txtBigo3.Text = ""
        lblBOListCode3.Text = ""
        lblCRListCode3.Text = ""
        'hsim 20200514 순번은 현재 존재하는 목록의 MAX+1
        Dim DBT As DataTable
        DBT = Nothing
        StrSQL = "select isnull(max(LO_Sun),1) + 1 AS A from LA_Order_List where LO_Code = '" & txtLOCode3.Text & "' and LO_Rev_No = '" & txtLORevNo3.Text & "'"
        Re_Count = DB_Select(DBT)
        txtSun3.Text = DBT.Rows(0).Item("A")
    End Sub

    Private Sub btnDWGSearch_Click(sender As Object, e As EventArgs) Handles btnDWGSearch.Click
        Dim pop1 As Frm_DV_POP = New Frm_DV_POP
        pop1.StartPosition = FormStartPosition.CenterScreen
        If (pop1.ShowDialog(Me) = DialogResult.OK) Then
            txtDWGCode3.Text = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("DV_Code").Value.ToString
        End If
        pop1.Dispose()
    End Sub

    Private Sub btnPLSearch3_Click(sender As Object, e As EventArgs) Handles btnPLSearch3.Click
        Dim cboDBT As New DataTable()
        Dim pop1 As Frm_PL_POP = New Frm_PL_POP
        pop1.StartPosition = FormStartPosition.CenterScreen
        If (pop1.ShowDialog(Me) = DialogResult.OK) Then
            cboDBT.Columns.Add("CR_PL_Code")
            cboDBT.Columns.Add("CR_PL_Name")
            cboDBT.Rows.Add()
            cboDBT.Rows(0).Item(0) = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("CR_PL_Code").Value.ToString
            cboDBT.Rows(0).Item(1) = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("CR_PL_Name").Value.ToString
            txtPLName3.Text = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("CR_PL_Name").Value.ToString
            lblCRListCode3.Text = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("CR_List_Code").Value.ToString
            cboPLName3.DataSource = cboDBT
            cboPLName3.ValueMember = "CR_PL_Code"
            cboPLName3.DisplayMember = "CR_PL_Name"
        End If
        pop1.Dispose()
    End Sub

    Private Sub btnBOMItmSearch_Click(sender As Object, e As EventArgs) Handles btnBOMItmSearch.Click
        Dim pop1 As Frm_BOM_Itm_POP = New Frm_BOM_Itm_POP
        pop1.StartPosition = FormStartPosition.CenterScreen
        If (pop1.ShowDialog(Me) = DialogResult.OK) Then
            txtBOMCode3.Text = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("BO_Code").Value.ToString
            txtBOMRev3.Text = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("BO_Rev_No").Value.ToString
            txtBOMSun3.Text = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("BO_Sun").Value.ToString
            lblBOListCode3.Text = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("BO_List_Code").Value.ToString
        End If
        pop1.Dispose()
    End Sub

    Private Sub btnDelete2_Click(sender As Object, e As EventArgs) Handles btnDelete2.Click
        Dim DBT As DataTable
        DBT = Nothing
        If MessageBox.Show("삭제하시겠습니까?", "삭제", MessageBoxButtons.YesNo) = DialogResult.Yes Then
            If txtLOCode3.Text <> "" Then
                StrSQL = "Delete LA_Order_List where LO_Code = '" & txtLOCode3.Text & "' and LO_Rev_No = '" & lstDetail.Rows(lstDetail.CurrentCell.RowIndex).Cells("LO_Rev_No").Value.ToString & "' and LO_Sun = " & txtSun3.Text
                Re_Count = DB_Execute()
                If Re_Count > 0 Then
                    MsgBox("삭제 완료")
                End If
                'hsim 20200515 처리 이력
                histLogStr = "사용자 " & logInUserName & " PR 항목 삭제 : " & txtLOCode3.Text & "-" &
                                 lstDetail.Rows(lstDetail.CurrentCell.RowIndex).Cells("LO_Rev_No").Value.ToString & "-" & txtSun3.Text
                Man_Log("Frm_LA_Order", "PR 항목 삭제", loginID, histLogStr, DateTime.Now.ToString(fmtStr2))
            Else
                MsgBox("선택된 PR No. 가 없습니다")
            End If
            LA_Load()
        End If
        btnAdd2.PerformClick()
    End Sub

    Private Sub btnSave_Click(sender As Object, e As EventArgs) Handles btnSave.Click
        Dim i%
        Dim DBT As DataTable, DBT2 As DataTable
        DBT = Nothing
        DBT2 = Nothing

        Try

            StrSQL = "SELECT * from LA_Order where LO_Code = '" & txtLOCode2.Text & "' And LO_Rev_No = (SELECT max(LO_Rev_No) from LA_Order where LO_Code = '" & txtLOCode2.Text & "' and LO_Rev_No = '" & txtRev2.Text & "')"
            Re_Count = DB_Select(DBT)

            StrSQL = "SELECT * from LA_Order where LO_Code = '" & txtLOCode2.Text & "' And LO_Rev_No = (SELECT max(LO_Rev_No) from LA_Order where LO_Code = '" & txtLOCode2.Text & "')"
            Re_Count2 = DB_Select(DBT2)

            '#1. 기존 입력 값 초기화
            clearTblRowValues(tblLaOrder)
            '#2. 입력자료 입력
            For i = 0 To tblLaOrder.Rows.Count - 1

                Select Case tblLaOrder.Rows(i).Item(0).ToString

                    Case "LO_Code"
                        If txtLOCode2.Text <> "" Then
                            tblLaOrder.Rows(i).Item(11) = txtLOCode2.Text
                        Else
                            tblLaOrder.Rows(i).Item(11) = PK_Make("LA_Order")
                        End If
                    Case "LO_Rev_No"
                        If txtRev2.Text <> "" Then
                            tblLaOrder.Rows(i).Item(11) = txtRev2.Text
                        ElseIf Re_Count > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT.Rows(0)("LO_Rev_No").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT2.Rows(0)("LO_Rev_No").ToString
                        Else
                            tblLaOrder.Rows(i).Item(11) = 1
                        End If
                    Case "LO_Name"
                        If txtLOName2.Text <> "" Then
                            tblLaOrder.Rows(i).Item(11) = txtLOName2.Text
                        ElseIf Re_Count > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT.Rows(0)("LO_Name").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT2.Rows(0)("LO_Name").ToString
                        End If
                    Case "LO_Job_No"
                        If txtLOJobNo2.Text <> "" Then
                            tblLaOrder.Rows(i).Item(11) = txtLOJobNo2.Text
                        ElseIf Re_Count > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT.Rows(0)("LO_Job_No").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT2.Rows(0)("LO_Job_No").ToString
                        End If
                    Case "LO_Issue_Date"
                        If dtpRegDate2.Value.ToString <> "" Then
                            tblLaOrder.Rows(i).Item(11) = dtpRegDate2.Value.ToString(fmtStr)
                        ElseIf Re_Count > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT.Rows(0)("LO_Issue_Date").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT2.Rows(0)("LO_Issue_Date").ToString
                        End If
                    Case "LO_Bigo"
                        If txtBigo2.Text <> "" Then
                            tblLaOrder.Rows(i).Item(11) = txtBigo2.Text
                        ElseIf Re_Count > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT.Rows(0)("LO_Bigo").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT2.Rows(0)("LO_Bigo").ToString
                        End If
                    Case "LO_Prepared"
                        If txtPrepared2.Text <> "" Then
                            tblLaOrder.Rows(i).Item(11) = cboPrepared.SelectedValue
                        ElseIf Re_Count > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT.Rows(0)("LO_Prepared").ToString
                        Else
                            If Re_Count2 > 0 Then
                                tblLaOrder.Rows(i).Item(11) = DBT2.Rows(0)("LO_Prepared").ToString
                            Else
                                tblLaOrder.Rows(i).Item(11) = loginID
                            End If
                        End If
                    Case "LO_Reviewed"
                        If txtReviewed2.Text <> "" Then
                            tblLaOrder.Rows(i).Item(11) = cboReviewed.SelectedValue
                        ElseIf Re_Count > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT.Rows(0)("LO_Reviewed").ToString
                        Else
                            If Re_Count2 > 0 Then
                                tblLaOrder.Rows(i).Item(11) = DBT2.Rows(0)("LO_Reviewed").ToString
                            Else
                                tblLaOrder.Rows(i).Item(11) = loginID
                            End If
                        End If
                    Case "LO_Approved"
                        If txtApprov2.Text <> "" Then
                            tblLaOrder.Rows(i).Item(11) = cboApproved.SelectedValue
                        ElseIf Re_Count > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT.Rows(0)("LO_Approved").ToString
                        Else
                            If Re_Count2 > 0 Then
                                tblLaOrder.Rows(i).Item(11) = DBT2.Rows(0)("LO_Approved").ToString
                            Else
                                tblLaOrder.Rows(i).Item(11) = loginID
                            End If
                        End If
                    Case "LO_Received"
                        If Re_Count > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT.Rows(0)("LO_Received").ToString
                        Else
                            If Re_Count2 > 0 Then
                                tblLaOrder.Rows(i).Item(11) = DBT2.Rows(0)("LO_Received").ToString
                            Else
                                tblLaOrder.Rows(i).Item(11) = loginID
                            End If
                        End If
                    Case "LO_Prepare_Date"
                        If dtpPrepared2.Value.ToString <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = dtpPrepared2.Value.ToString(fmtStr2)
                        ElseIf Re_Count > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT.Rows(0)("LO_Prepare_Date").ToString
                        Else
                            If Re_Count2 > 0 Then
                                tblLaOrder.Rows(i).Item(11) = DBT2.Rows(0)("LO_Prepare_Date").ToString
                            Else
                                tblLaOrder.Rows(i).Item(11) = DateTime.Now.ToString(fmtStr2)
                            End If
                        End If
                    Case "LO_Review_Date"
                        If dtpReviewed2.Value.ToString <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = dtpReviewed2.Value.ToString(fmtStr2)
                        ElseIf Re_Count > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT.Rows(0)("LO_Review_Date").ToString
                        Else
                            If Re_Count2 > 0 Then
                                tblLaOrder.Rows(i).Item(11) = DBT2.Rows(0)("LO_Review_Date").ToString
                            Else
                                tblLaOrder.Rows(i).Item(11) = DateTime.Now.ToString(fmtStr2)
                            End If
                        End If
                    Case "LO_Approve_Date"
                        If dtpApprov2.Value.ToString <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = dtpApprov2.Value.ToString(fmtStr2)
                        ElseIf Re_Count > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT.Rows(0)("LO_Approve_Date").ToString
                        Else
                            If Re_Count2 > 0 Then
                                tblLaOrder.Rows(i).Item(11) = DBT2.Rows(0)("LO_Approve_Date").ToString
                            Else
                                tblLaOrder.Rows(i).Item(11) = DateTime.Now.ToString(fmtStr2)
                            End If
                        End If
                    Case "LO_Receive_Date"
                        If Re_Count > 0 Then
                            tblLaOrder.Rows(i).Item(11) = DBT.Rows(0)("LO_Receive_Date").ToString
                        Else
                            If Re_Count2 > 0 Then
                                tblLaOrder.Rows(i).Item(11) = DBT2.Rows(0)("LO_Receive_Date").ToString
                            Else
                                tblLaOrder.Rows(i).Item(11) = DateTime.Now.ToString(fmtStr2)
                            End If
                        End If
                End Select
            Next



            If Re_Count > 0 Then
                Re_Count2 = fnTableUpdate("dbo.LA_Order", tblLaOrder)
                If Re_Count2 > 0 Then
                    MsgBox("저장 완료")
                Else
                    MsgBox("저장 실패")
                End If
            Else
                Re_Count2 = fnTableInsert("dbo.LA_Order", tblLaOrder)
                If Re_Count2 > 0 Then
                    MsgBox("저장 완료")
                Else
                    MsgBox("저장 실패")
                End If
            End If

            If Re_Count > 0 Then
                prcType = "수정" '수정
            Else
                prcType = "신규입력" '입력
            End If

            If prcType = "수정" Then
                'hsim 20200515 처리 이력
                histLogStr = "사용자 " & logInUserName & " PR 정보 수정 : " & txtLOCode2.Text & "-" & txtRev2.Text
            Else
                'hsim 20200515 처리 이력
                histLogStr = "사용자 " & logInUserName & " PR 정보 신규 입력 : " & txtLOCode2.Text & "-" & txtRev2.Text
            End If
            Man_Log("Frm_LA_Order", prcType, loginID & "-" & logInUserName, histLogStr, DateTime.Now.ToString(fmtStr2))
        Catch ex As Exception
            MsgBox(ex.Message)
            Exit Sub
        End Try

        LA_Load()

    End Sub

    Private Sub btnSave2_Click(sender As Object, e As EventArgs) Handles btnSave2.Click
        Dim i%
        Dim DBT As DataTable, DBT2 As DataTable
        DBT = Nothing
        DBT2 = Nothing

        'hsim 20200515 개정이력 확인 정보
        Dim prcType As String
        Dim histLogStr As String

        Dim fmtStr As String, fmtStr2 As String
        fmtStr = String.Format("yyyy-MM-dd")
        fmtStr2 = String.Format("yyyy-MM-dd HH:mm:ss")

        Try

            StrSQL = "SELECT * from LA_Order_List where LO_Code = '" & txtLOCode3.Text & "' And LO_Rev_No = (SELECT max(LO_Rev_No) from LA_Order_List where LO_Code = '" & txtLOCode3.Text & "' and LO_Rev_No = '" & txtLORevNo3.Text & "')"
            Re_Count = DB_Select(DBT)

            StrSQL = "SELECT * from LA_Order_List where LO_Code = '" & txtLOCode3.Text & "' And LO_Rev_No = (SELECT max(LO_Rev_No) from LA_Order_List where LO_Code = '" & txtLOCode3.Text & "')"
            Re_Count2 = DB_Select(DBT2)

            '#1. 기존 입력 값 초기화
            clearTblRowValues(tblLaOrderList)
            '#2. 입력자료 입력
            For i = 0 To tblLaOrderList.Rows.Count - 1

                Select Case tblLaOrderList.Rows(i).Item(0).ToString

                    Case "LO_List_Code"
                        If txtLOListCode3.Text <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = txtLOListCode3.Text
                        Else
                            tblLaOrderList.Rows(i).Item(11) = PK_Make("LA_Order_List")
                        End If
                    Case "LO_Code"
                        If txtLOCode3.Text <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = txtLOCode3.Text
                        ElseIf Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_Code").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_Code").ToString
                        End If
                    Case "LO_Rev_No"
                        If txtLORevNo3.Text <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = txtLORevNo3.Text
                        ElseIf Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_Rev_No").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_Rev_No").ToString
                        Else
                            tblLaOrderList.Rows(i).Item(11) = 1
                        End If
                    Case "LO_Sun"
                        If txtSun3.Text <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = txtSun3.Text
                        ElseIf Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_Sun").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_Sun").ToString
                        End If
                    Case "LO_CR_List_Code"
                        If lblCRListCode3.Text <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = lblCRListCode3.Text
                        ElseIf Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_CR_List_Code").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_CR_List_Code").ToString
                        End If
                    Case "LO_BO_List_Code"
                        If lblBOListCode3.Text <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = lblBOListCode3.Text
                        ElseIf Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_BO_List_Code").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_BO_List_Code").ToString
                        End If
                    Case "LO_DV_Code"
                        If txtDWGCode3.Text <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = txtDWGCode3
                        ElseIf Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_DV_Code").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_DV_Code").ToString
                        End If
                    Case "LO_Itm_Desc"
                        If txtItmDesc3.Text <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = txtItmDesc3.Text
                        ElseIf Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_Itm_Desc").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_Itm_Desc").ToString
                        End If
                    Case "LO_Itm_Part_No"
                        If txtItmPartNo3.Text <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = txtItmPartNo3.Text
                        ElseIf Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_Itm_Part_No").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_Itm_Part_No").ToString
                        End If
                    Case "LO_Itm_Part_Name"
                        If txtItmPartName3.Text <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = txtItmPartName3.Text
                        ElseIf Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_Itm_Part_Name").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_Itm_Part_Name").ToString
                        End If
                    Case "LO_Itm_Spec"
                        If txtSpec3.Text <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = txtSpec3.Text
                        ElseIf Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_Itm_Spec").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_Itm_Spec").ToString
                        End If
                    Case "LO_Itm_Size"
                        If txtSize3.Text <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = txtSize3.Text
                        ElseIf Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_Itm_Size").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_Itm_Size").ToString
                        End If
                    Case "LO_Itm_Unit"
                        If cboItmUnit3.SelectedValue <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = cboItmUnit3.SelectedValue
                        ElseIf Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_Itm_Unit").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_Itm_Unit").ToString
                        End If
                    Case "LO_Itm_Qty"
                        If txtQty3.Text <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = txtQty3.Text
                        ElseIf Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_Itm_Qty").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_Itm_Qty").ToString
                        End If
                    Case "LO_PS_Code"
                        If txtBigo3.Text <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = txtBigo3.Text
                        ElseIf Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_PS_Code").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_PS_Code").ToString
                        End If
                    Case "LO_Itm_Delivery_Date"
                        If dtpDelivery3.Value.ToString <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = dtpDelivery3.Value.ToString(fmtStr2)
                        ElseIf Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_Itm_Delivery_Date").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_Itm_Delivery_Date").ToString
                        End If
                    Case "LO_Itm_Bigo"
                        If txtBigo3.Text <> "" Then
                            tblLaOrderList.Rows(i).Item(11) = txtBigo3.Text
                        ElseIf Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_Itm_Bigo").ToString
                        ElseIf Re_Count2 > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_Itm_Bigo").ToString
                        End If
                    Case "LO_Prepared"
                        If Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_Prepared").ToString
                        Else
                            If Re_Count2 > 0 Then
                                tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_Prepared").ToString
                            Else
                                tblLaOrderList.Rows(i).Item(11) = loginID
                            End If
                        End If
                    Case "LO_Prepare_Date"
                        If Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_Prepare_Date").ToString
                        Else
                            If Re_Count2 > 0 Then
                                tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_Prepare_Date").ToString
                            Else
                                tblLaOrderList.Rows(i).Item(11) = DateTime.Now.ToString(fmtStr2)
                            End If
                        End If
                    Case "LO_Updated"
                        If Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_Updated").ToString
                        Else
                            If Re_Count2 > 0 Then
                                tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_Updated").ToString
                            Else
                                tblLaOrderList.Rows(i).Item(11) = loginID
                            End If
                        End If
                    Case "LO_Update_Date"
                        If Re_Count > 0 Then
                            tblLaOrderList.Rows(i).Item(11) = DBT.Rows(0)("LO_Update_Date").ToString
                        Else
                            If Re_Count2 > 0 Then
                                tblLaOrderList.Rows(i).Item(11) = DBT2.Rows(0)("LO_Update_Date").ToString
                            Else
                                tblLaOrderList.Rows(i).Item(11) = DateTime.Now.ToString(fmtStr2)
                            End If
                        End If
                End Select
            Next



            If Re_Count > 0 Then
                Re_Count2 = fnTableUpdate("dbo.LA_Order_List", tblLaOrderList)
                If Re_Count2 > 0 Then
                    MsgBox("저장 완료")
                Else
                    MsgBox("저장 실패")
                End If
            Else
                Re_Count2 = fnTableInsert("dbo.LA_Order_List", tblLaOrderList)
                If Re_Count2 > 0 Then
                    MsgBox("저장 완료")
                Else
                    MsgBox("저장 실패")
                End If
            End If

            If Re_Count > 0 Then
                prcType = "수정" '수정
            Else
                prcType = "신규입력" '입력
            End If

            If prcType = "수정" Then
                'hsim 20200515 처리 이력
                histLogStr = "사용자 " & logInUserName & " PR 항목 정보 수정 : " & txtLOCode3.Text & "-" & txtLORevNo3.Text & "-" & txtSun3.Text
            Else
                'hsim 20200515 처리 이력
                histLogStr = "사용자 " & logInUserName & " PR 항목정보 신규 입력 : " & txtLOCode3.Text & "-" & txtLORevNo3.Text & "-" & txtSun3.Text
            End If
            Man_Log("Frm_LA_Order", prcType, loginID & "-" & logInUserName, histLogStr, DateTime.Now.ToString(fmtStr2))

        Catch ex As Exception
            MsgBox(ex.Message)
            Exit Sub

        End Try

        StrSQL = " SELECT a.LO_List_Code LO_List_Code, a.LO_Code LO_Code, a.LO_Rev_No LO_Rev_No, a.LO_Sun LO_Sun  " &
                 "        ,a.LO_Itm_Desc LO_Itm_Desc, a.LO_DV_Code LO_DV_Code, a.LO_Itm_Part_No LO_Itm_Part_No, a.LO_Itm_Part_Name LO_Itm_Part_Name " &
                 "        ,a.LO_Itm_Spec LO_Itm_Spec, a.LO_Itm_Size LO_Itm_Size, a.LO_Itm_Unit LO_Itm_Unit, a.LO_Itm_Qty LO_Itm_Qty " &
                 "        ,a.LO_BO_List_Code LO_BO_List_Code, a.LO_CR_List_Code LO_CR_List_Code, a.LO_PS_Code LO_PS_Code, a.LO_Itm_Delivery_Date LO_Itm_Delivery_Date " &
                 "        ,a.LO_Itm_Bigo LO_Itm_Bigo, a.LO_Prepared LO_Prepared, a.LO_Prepare_Date LO_Prepare_Date, a.LO_Updated LO_Updated, a.LO_Update_Date LO_Update_Date " &
                 ", (select Base_Name from Base_Code where Base_Sel_Code = '1050' and Base_Code = a.LO_Itm_Unit ) LO_Itm_Unit_Name " & '수량 단위"
                 ", (select CR_PL_Code from CR_Contract_List where CR_List_Code = a.LO_CR_List_Code) As LO_CR_PL_Code " &
                 ", (select CR_PL_Name from CR_Contract_List where CR_List_Code = a.LO_CR_List_Code) As LO_CR_PL_Name " &
                 ", (select BO_Itm_Name from BO_BOM_List where BO_List_Code = a.LO_BO_List_Code) As LO_BO_List_Name " &
                 ", (select CR_PL_Name from CR_Contract_List where CR_List_Code = a.LO_CR_List_Code) As LO_CR_List_Name " &
                 ", (select BO_Code from BO_BOM_List where BO_List_Code = a.LO_BO_List_Code) As BO_Code " &
                 ", (select BO_Rev_No from BO_BOM_List where BO_List_Code = a.LO_BO_List_Code) As BO_Rev_No " &
                 ", (select BO_Sun from BO_BOM_List where BO_List_Code = a.LO_BO_List_Code) As BO_Sun " &
                 " FROM LA_Order_List a " &
                 " Where a.LO_Code = '" & lstMain.Rows(lstMain.CurrentCell.RowIndex).Cells("LO_Code2").Value.ToString() & "'" &
                 " And a.LO_Rev_No = '" & lstMain.Rows(lstMain.CurrentCell.RowIndex).Cells("LO_Rev_No2").Value.ToString() & "'" &
                 " order By a.LO_Sun ASC "
        Re_Count = DB_Select(DBT)

        lstDetail.DataSource = DBT
            lstDetail.ClearSelection()


    End Sub

    Private Sub btnGetBOMItems_Click(sender As Object, e As EventArgs) Handles btnGetBOMItems.Click

        Dim i%, j%
        Dim DBTinit As DataTable, DBT As DataTable, DBT2 As DataTable
        Dim initTgtCount As Int32
        DBTinit = Nothing
        DBT = Nothing
        DBT2 = Nothing

        Dim tmpBOCode As New String(String.Empty)
        Dim tmpBORevNo As New String(String.Empty)
        ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        Try
            '#1. popUp으로 BOM 정보를 가져옴
            Dim pop1 As Frm_BOM_POP = New Frm_BOM_POP
            pop1.StartPosition = FormStartPosition.CenterScreen
            If (pop1.ShowDialog(Me) = DialogResult.OK) Then
                tmpBOCode = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("BO_Code").Value.ToString
                tmpBORevNo = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("BO_Rev_No").Value.ToString
            End If
            pop1.Dispose()
            '#2. 진행할 지 물어봄
            If MessageBox.Show("BOM번호" & tmpBOCode & "/개정번호 " & tmpBORevNo & "의 전체항목을 PR 목록에 추가하시겠습니까?", "BOM항목 가져오기", MessageBoxButtons.YesNo) = DialogResult.Yes Then

                '#3-1 BOM 목록 가져오기
                StrSQL = "SELECT * from BO_BOM_List where BO_Code = '" & tmpBOCode & "' And BO_Rev_No = " & tmpBORevNo & " order by BO_Sun asc "
                Console.WriteLine("BOM목록 가져오기 SQL =>" + StrSQL)
                initTgtCount = DB_Select(DBTinit)
                If initTgtCount < 1 Then
                    MessageBox.Show("BOM번호" & tmpBOCode & "/개정번호 " & tmpBORevNo & "의 BOM 목록이 존재하지 않습니다.", "BOM항목 가져오기", MessageBoxButtons.OK)
                    Exit Sub
                End If

                StrSQL = "SELECT * from LA_Order_List LAL where 1=1 " &
                     " AND LO_Code = '" & txtLOCode2.Text & "' " &
                     " AND LO_Rev_No = " & txtRev2.Text '&
                '" AND '" & tmpBOCode & "' = (SELECT BO_Code from BO_BOM_List where BO_List_Code = LAL.LO_BO_List_Code ) "
                Console.WriteLine("BOM목록 존재 여부 SQL =>" + StrSQL)
                Re_Count = DB_Select(DBT)

                '#3-2 BOM 목록과 중복되는 기존 PR목록 삭제 처리
                If Re_Count > 0 Then

                    If MessageBox.Show("BOM번호" & tmpBOCode & "/개정번호 " & tmpBORevNo & "의 항목이 PR 목록에 존재합니다. 삭제 후 진행하시겠습니까?", "BOM항목 가져오기", MessageBoxButtons.YesNo) = DialogResult.Yes Then
                        StrSQL = " DELETE from LA_Order_List LAL where 1=1 " &
                             " AND LO_Code = '" & txtLOCode2.Text & "' " &
                             " AND LO_Rev_No = " & txtRev2.Text &
                             " AND '" & tmpBOCode & "' = (SELECT BO_Code from BO_BOM_List where BO_List_Code = LAL.LO_BO_List_Code ) "
                        Re_Count = DB_Select(DBT)
                        If Re_Count > 0 Then
                            MessageBox.Show("BOM번호" & tmpBOCode & "/개정번호 " & tmpBORevNo & "의 기존 PR 목록을 삭제하였습니다.", "BOM항목 가져오기", MessageBoxButtons.OK)
                        Else
                            MessageBox.Show("BOM번호" & tmpBOCode & "/개정번호 " & tmpBORevNo & "의 기존 PR 목록을 삭제에 실패하였습니다.", "BOM항목 가져오기", MessageBoxButtons.OK)
                            Exit Sub
                        End If
                    End If

                End If


                StrSQL = "SELECT isnull(max(LO_Sun),0) from LA_Order_List where LO_Code = '" & txtLOCode2.Text & "' And LO_Rev_No = " & txtRev2.Text
                Console.WriteLine("기존 PR목록 순번 SQL =>" + StrSQL)
                Re_Count2 = DB_Select(DBT2)
                Dim tmpMaxSun As New Int32
                tmpMaxSun = Integer.Parse(DBT2.Rows(0).Item(0).ToString())

                For j = 0 To initTgtCount - 1

                    '#3-3 하나씩 입력 
                    tmpMaxSun += 1
                    '#1. 기존 입력 값 초기화
                    clearTblRowValues(tblLaOrderList)
                    '#2. 입력자료 입력
                    For i = 0 To tblLaOrderList.Rows.Count - 1

                        Select Case tblLaOrderList.Rows(i).Item(0).ToString

                            Case "LO_List_Code"
                                tblLaOrderList.Rows(i).Item(11) = PK_Make("LA_Order_List")
                            Case "LO_Code"
                                tblLaOrderList.Rows(i).Item(11) = txtLOCode2.Text
                            Case "LO_Rev_No"
                                tblLaOrderList.Rows(i).Item(11) = txtRev2.Text
                            Case "LO_Sun"
                                tblLaOrderList.Rows(i).Item(11) = tmpMaxSun.ToString
                            Case "LO_CR_List_Code"
                                tblLaOrderList.Rows(i).Item(11) = DBTinit.Rows(j)("BO_CR_List_Code").ToString
                            Case "LO_BO_List_Code"
                                tblLaOrderList.Rows(i).Item(11) = DBTinit.Rows(j)("BO_List_Code").ToString
                            Case "LO_DV_Code"
                                tblLaOrderList.Rows(i).Item(11) = DBTinit.Rows(j)("BO_DV_Code").ToString
                            Case "LO_Itm_Desc"
                                tblLaOrderList.Rows(i).Item(11) = DBTinit.Rows(j)("BO_Itm_Name").ToString
                            Case "LO_Itm_Part_No"
                                tblLaOrderList.Rows(i).Item(11) = DBTinit.Rows(j)("BO_Itm_Code").ToString
                            Case "LO_Itm_Part_Name"
                                tblLaOrderList.Rows(i).Item(11) = DBTinit.Rows(j)("BO_Itm_Name").ToString
                            Case "LO_Itm_Spec"
                                tblLaOrderList.Rows(i).Item(11) = DBTinit.Rows(j)("BO_Itm_Standard").ToString
                            Case "LO_Itm_Size"
                                tblLaOrderList.Rows(i).Item(11) = DBTinit.Rows(j)("BO_Itm_Size").ToString
                            Case "LO_Itm_Unit"
                                tblLaOrderList.Rows(i).Item(11) = DBTinit.Rows(j)("BO_Itm_Unit").ToString
                            Case "LO_Itm_Qty"
                                tblLaOrderList.Rows(i).Item(11) = DBTinit.Rows(j)("BO_Itm_Qty").ToString
                            Case "LO_PS_Code"
                                tblLaOrderList.Rows(i).Item(11) = ""
                            Case "LO_Itm_Delivery_Date"
                                tblLaOrderList.Rows(i).Item(11) = dtpDelivery3.Value.ToString
                            Case "LO_Itm_Bigo"
                                tblLaOrderList.Rows(i).Item(11) = DBTinit.Rows(j)("BO_Bigo").ToString
                            Case "LO_Prepared"
                                tblLaOrderList.Rows(i).Item(11) = loginID
                            Case "LO_Prepare_Date"
                                tblLaOrderList.Rows(i).Item(11) = DateTime.Now.ToString(fmtStr2)
                            Case "LO_Updated"
                                tblLaOrderList.Rows(i).Item(11) = loginID
                            Case "LO_Update_Date"
                                tblLaOrderList.Rows(i).Item(11) = DateTime.Now.ToString(fmtStr2)
                        End Select
                    Next

                    Re_Count2 = fnTableInsert("dbo.LA_Order_List", tblLaOrderList)
                    If Re_Count2 > 0 Then
                        'MsgBox("저장 완료")
                    Else
                        MsgBox("저장에 실패하였습니다. 관리자에 문의하세요.")
                        Exit Sub
                    End If

                Next

            End If

            'hsim 20200515 처리 이력
            histLogStr = "사용자 " & logInUserName & " PR 항목정보 BOM에서 가져오기 - 신규 입력 : " & txtLOCode2.Text & "-" & txtRev2.Text
            Man_Log("Frm_LA_Order", "신규입력", loginID & "-" & logInUserName, histLogStr, DateTime.Now.ToString(fmtStr2))

        Catch ex As Exception

            MsgBox(ex.Message)
            Exit Sub

        End Try

        LA_Load()
        ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    End Sub

    Private Sub btnPSSearch_Click(sender As Object, e As EventArgs) Handles btnPSSearch.Click
        Dim pop1 As Frm_PS_POP = New Frm_PS_POP
        pop1.StartPosition = FormStartPosition.CenterScreen
        If (pop1.ShowDialog(Me) = DialogResult.OK) And pop1.DataGridView1.Rows.Count > 0 Then
            txtPSNo3.Text = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("PS_Code").Value.ToString
        End If
        pop1.Dispose()
    End Sub

    Private Sub btnPreparedSearch_Click(sender As Object, e As EventArgs) Handles btnPreparedSearch.Click
        Dim cboDBT As New DataTable()
        Dim pop1 As Frm_Man_POP = New Frm_Man_POP
        pop1.StartPosition = FormStartPosition.CenterScreen
        If (pop1.ShowDialog(Me) = DialogResult.OK) Then
            cboDBT.Columns.Add("Man_Code")
            cboDBT.Columns.Add("Man_Name")
            cboDBT.Rows.Add()
            cboDBT.Rows(0).Item(0) = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("Man_Code").Value.ToString
            cboDBT.Rows(0).Item(1) = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("Man_Name").Value.ToString
            txtPrepared2.Text = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("Man_Name").Value.ToString
            cboPrepared.DataSource = cboDBT
            cboPrepared.ValueMember = "Man_Code"
            cboPrepared.DisplayMember = "Man_Name"
            cboPrepared.SelectedValue = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("Man_Code").Value.ToString
        End If
        pop1.Dispose()
    End Sub

    Private Sub btnReviewedMSSearch_Click(sender As Object, e As EventArgs) Handles btnReviewedSearch.Click
        Dim cboDBT As New DataTable()
        Dim pop1 As Frm_Man_POP = New Frm_Man_POP
        pop1.StartPosition = FormStartPosition.CenterScreen
        If (pop1.ShowDialog(Me) = DialogResult.OK) Then
            cboDBT.Columns.Add("Man_Code")
            cboDBT.Columns.Add("Man_Name")
            cboDBT.Rows.Add()
            cboDBT.Rows(0).Item(0) = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("Man_Code").Value.ToString
            cboDBT.Rows(0).Item(1) = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("Man_Name").Value.ToString
            txtReviewed2.Text = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("Man_Name").Value.ToString
            cboReviewed.DataSource = cboDBT
            cboReviewed.ValueMember = "Man_Code"
            cboReviewed.DisplayMember = "Man_Name"
            cboReviewed.SelectedValue = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("Man_Code").Value.ToString
        End If
        pop1.Dispose()
    End Sub

    Private Sub btnApprovedSearch_Click(sender As Object, e As EventArgs) Handles btnApprovedSearch.Click
        Dim cboDBT As New DataTable()
        Dim pop1 As Frm_Man_POP = New Frm_Man_POP
        pop1.StartPosition = FormStartPosition.CenterScreen
        If (pop1.ShowDialog(Me) = DialogResult.OK) Then
            cboDBT.Columns.Add("Man_Code")
            cboDBT.Columns.Add("Man_Name")
            cboDBT.Rows.Add()
            cboDBT.Rows(0).Item(0) = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("Man_Code").Value.ToString
            cboDBT.Rows(0).Item(1) = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("Man_Name").Value.ToString
            txtApprov2.Text = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("Man_Name").Value.ToString
            cboApproved.DataSource = cboDBT
            cboApproved.ValueMember = "Man_Code"
            cboApproved.DisplayMember = "Man_Name"
            cboApproved.SelectedValue = pop1.DataGridView1.Rows(pop1.DataGridView1.CurrentCell.RowIndex).Cells("Man_Code").Value.ToString
        End If
        pop1.Dispose()
    End Sub

    Private Sub Button1_Click(sender As Object, e As EventArgs) Handles btnExcelDown.Click
        Dim i As Integer
        Dim i2 As Integer = 0
        Dim cnt As Integer = 0
        Dim DBT As DataTable
        DBT = Nothing
        xlapp = New Excel.Application
        xlbook = xlapp.Workbooks.Add(Application.StartupPath + "\\Excel\\기술팀\\구매요구서.xlsx")
        xlsheet = xlbook.Worksheets(1)
        Try


            If lstDetail.RowCount > 0 Then



                For i = 0 To lstDetail.RowCount - 1
                    i2 += 2

                    If (i + 1) Mod 10 = 1 Then
                        xlsheet.Range("K" + (1 + cnt * 35).ToString).Value = txtLOCode2.Text
                        xlsheet.Range("K" + (2 + cnt * 35).ToString).Value = txtRev2.Text
                        xlsheet.Range("K" + (3 + cnt * 35).ToString).Value = dtpRegDate2.Value.ToString("yyyy-MM-dd")
                        xlsheet.Range("C" + (4 + cnt * 35).ToString).Value = txtLOJobNo2.Text
                        xlsheet.Range("K" + (4 + cnt * 35).ToString).Value = txtJobName2.Text
                        If i > 0 Then
                            i2 += 15
                        End If

                        cnt += 1

                    End If
                    xlsheet.Range("A" + ((i2) + 5).ToString).Value = i + 1
                    xlsheet.Range("B" + ((i2) + 5).ToString).Value = lstDetail.Rows(i).Cells("LO_Itm_Desc").Value.ToString
                    xlsheet.Range("D" + ((i2) + 5).ToString).Value = lstDetail.Rows(i).Cells("LO_DV_Code").Value.ToString
                    xlsheet.Range("D" + ((i2) + 6).ToString).Value = lstDetail.Rows(i).Cells("LO_Itm_Part_No").Value.ToString
                    xlsheet.Range("E" + ((i2) + 6).ToString).Value = lstDetail.Rows(i).Cells("LO_Itm_Part_Name").Value.ToString
                    xlsheet.Range("F" + ((i2) + 5).ToString).Value = lstDetail.Rows(i).Cells("LO_Itm_Spec").Value.ToString
                    xlsheet.Range("H" + ((i2) + 5).ToString).Value = lstDetail.Rows(i).Cells("LO_Itm_Size").Value.ToString
                    xlsheet.Range("I" + ((i2) + 5).ToString).Value = lstDetail.Rows(i).Cells("LO_Itm_Unit").Value.ToString
                    xlsheet.Range("J" + ((i2) + 5).ToString).Value = lstDetail.Rows(i).Cells("LO_Itm_Qty").Value.ToString
                    xlsheet.Range("K" + ((i2) + 5).ToString).Value = lstDetail.Rows(i).Cells("LO_PS_Code3").Value.ToString
                    xlsheet.Range("M" + ((i2) + 5).ToString).Value = lstDetail.Rows(i).Cells("LO_Itm_Delivery_Date").Value.ToString



                Next
                If SaveFileDialog1.ShowDialog = DialogResult.OK Then
                    xlapp.ActiveWorkbook.SaveAs(SaveFileDialog1.FileName)


                    MsgBox("Excel 저장 완료")
                End If
            End If


        Catch ex As Exception
            MsgBox(ex.ToString)
        Finally
            xlapp.DisplayAlerts = False

            Try
                If xlbook IsNot Nothing Then
                    xlbook.Close(Nothing, Nothing, Nothing)
                End If
                xlapp.Workbooks.Close()
                xlapp.Quit()
                If xlsheet IsNot Nothing Then
                    Marshal.ReleaseComObject(xlsheet)
                End If
                If xlbook IsNot Nothing Then
                    Marshal.ReleaseComObject(xlbook)
                End If
                If xlapp IsNot Nothing Then
                    Marshal.ReleaseComObject(xlapp)
                End If

            Catch
            End Try
            xlsheet = Nothing
            xlbook = Nothing
            xlapp = Nothing
            GC.Collect()
            GC.WaitForPendingFinalizers()
        End Try
    End Sub

    Private Sub txtQty3_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtQty3.KeyPress
        If Char.IsDigit(e.KeyChar) = False Or e.KeyChar = Convert.ToChar(Keys.Back) Then
            e.Handled = True
        End If
    End Sub

    Private Sub btnSearch_Click(sender As Object, e As EventArgs) Handles btnSearch.Click
        LA_Load()
    End Sub

End Class
